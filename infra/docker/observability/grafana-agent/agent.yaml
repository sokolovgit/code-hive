server:
  log_level: info

metrics:
  global:
    scrape_interval: 15s
    external_labels:
      cluster: local-dev
      __replica__: agent-1
  configs:
    - name: default
      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['prometheus:9090']

logs:
  configs:
    - name: default
      positions:
        filename: /tmp/positions.yaml
      clients:
        - url: http://loki:3100/loki/api/v1/push
      scrape_configs:
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            # Extract service name from container name
            - source_labels: [__meta_docker_container_name]
              regex: '/(.*)'
              target_label: service
              replacement: '${1}'
            # Extract environment from container labels
            - source_labels: [__meta_docker_container_label_env]
              target_label: env
            # Keep only containers from our network
            - source_labels: [__meta_docker_network_label_com_docker_compose_network]
              regex: backend-net
              action: keep
            # Standard labels
            - source_labels: [__meta_docker_container_id]
              target_label: container_id
            - source_labels: [__meta_docker_container_name]
              target_label: container_name
            - source_labels: [__meta_docker_container_log_stream]
              target_label: log_stream

integrations:
  prometheus_remote_write:
    - url: http://prometheus:9090/api/v1/write
      queue_config:
        max_samples_per_send: 1000
        batch_send_deadline: 5s

traces:
  configs:
    - name: default
      receivers:
        otlp:
          protocols:
            http:
              endpoint: 0.0.0.0:4318
            grpc:
              endpoint: 0.0.0.0:4317
      remote_write:
        - endpoint: tempo:4317
          insecure: true
